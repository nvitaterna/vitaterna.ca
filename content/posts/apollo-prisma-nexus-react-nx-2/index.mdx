---
title: "Using Apollo, Prisma, and Nexus with React in an Nx Workspace - Part 2"
date: 2021-05-25
description: ""
tags:
  - nx
  - react
  - graphql
  - apollo
  - nexus
  - prisma
---

import Link from "../../../src/components/link";

You can go back to <Link to="/using-apollo-prisma-and-nexus-with-react-in-an-nx-workspace-part-1">part 1</Link> if you missed it. You can also follow along from the end of that article by cloning <Link to="https://github.com/nvitaterna/nx-react-graphql-starter/tree/part-one">this repo</Link> as so:

```bash noLineNumbers
git clone git@github.com:nvitaterna/nx-react-graphql-starter.git -b part-one
```

## Workflow Improvements

There are a lot of improvements that can be made to automate the code generation commands you used earler.

Say you want to add a `title` field to your TodoItem model. Go ahead and modify your schema to add this field:

```prisma:title=libs/prisma-client/prisma/schema.prisma noLineNumbers {5}
model TodoItem {
  id    Int     @id @default(autoincrement())
  text  String
  done  Boolean @default(false)
  title String?
}
```

You may make another migration as well to reflect the changes on your database. This will create another migration file:

```bash noLineNumbers
yarn prisma migrate dev --name add-title-todo
```

The next steps would be to regenerate your prisma client, regenerate your nexus typings, and regenerate your frontend data accessors. Instead of having to manually run each command every time, you can put this into Nx's workflow via the `workspace.json` file.

For each project that has code generation, you will add another target named `generate-gql` (the name is arbitrary). This will utilize the <Link to="https://nx.dev/latest/angular/workspace/run-commands-executor">run commands</Link> tool from Nx. The commands that you are adding here are were manually run in the first part of this series:

```json:title=workspace.json noLineNumbers {5-10,15-20,25-30}
{
  "projects": {
    "prisma-client": {
      "targets": {
        "generate-gql": {
          "executor": "@nrwl/workspace:run-commands",
          "options": {
            "command": "yarn prisma generate"
          }
        }
      }
    },
    "api": {
      "targets": {
        "generate-gql": {
          "executor": "@nrwl/workspace:run-commands",
          "options": {
            "command": "yarn ts-node --project ./tsconfig.base.json --compiler-options '{\"module\":\"CommonJS\"}' --transpile-only apps/api/src/graphql/schema"
          }
        }
      }
    },
    "data-access": {
      "targets": {
        "generate-gql": {
          "executor": "@nrwl/workspace:run-commands",
          "options": {
            "command": "yarn graphql-codegen --config libs/data-access/codegen.yml"
          }
        }
      }
    }
  }
}
```

Nx has another option for running commands _only for affected projects_. This requires your dependency tree to be setup correctly - which is usually taken care of by imports. You can take a look at the dependency graph by running the following command:

```bash noLineNumbers
yarn nx dep-graph
```

The tool will tell you where you can view the dependency graph (<Link to="http://127.0.0.1:4211/">http://127.0.0.1:4211/</Link>). Click the `Select All` button. You'll see that there is a link missing between `data-access` and `api`. This is because there are no actual imports happening - but they should be linked as the `data-access` library depends on the api for code generation.

You can fix that by adding an implicit dependency to the `data-access` project in the `nx.json` file:

```json:title=nx.json noLineNumbers {5}
{
  "projects": {
    "data-access": {
      "tags": [],
      "implicitDependencies": ["api"]
    }
  }
}
```

Restart the dependcy graph and you'll see that everything is linked up properly after refreshing the page and selecting all projects again.

Before you run the generate-gql command for affected projects, add the following option to your `nx.json` file to make sure that the command gets ran in order of project dependencies as each step relies on the last:

```json:title=nx.json noLineNumbers {6}
{
  "tasksRunnerOptions": {
    "default": {
      "options": {
        "cacheableOperations": ["build", "lint", "test", "e2e"],
        "strictlyOrderedTargets": ["generate-gql"]
      }
    }
  }
}
```

Now you can run `generate-gql` for all <Link to="https://nx.dev/latest/angular/cli/affected">affected</Link> projects:

```bash noLineNumbers
yarn nx affected --target=generate-gql
```

You'll see this run the `generate-gql` commands you set up above in the correct order based on dependencies.

Now, what if you pulled down the project and everything is up-to-date? The affected command will not run anything - even though you don't have the generated files. You can use the following command to run `generate-gql` for any projects that have that target:

```bash noLineNumbers
yarn nx run-many --target=generate-gql --all
```

Once again, you'll see that the tasks ran in the correct order. Update your todo item type file file in your `api` project:

```ts:title=apps/api/src/graphql/todo-item.ts {10}
import { mutationField, objectType, queryField } from 'nexus';

export const todoItemTypes = [
  objectType({
    name: 'TodoItem',
    definition(t) {
      t.model.id();
      t.model.text();
      t.model.done();
      t.model.title();
    },
  }),
  queryField((t) => {
    t.crud.todoItems();
  }),
  mutationField((t) => {
    t.crud.createOneTodoItem();
  }),
];
```